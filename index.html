<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Cloner & Build Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <style>
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --accent-color: #58a6ff;
            --success-color: #3fb950;
            --error-color: #f85149;
            --border-color: #30363d;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .toolbar {
            background-color: #161b22;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        input[type="text"] {
            flex-grow: 1;
            background-color: #0d1117;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        button {
            background-color: #238636;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background-color: #2ea043; }
        button:disabled { background-color: #21262d; color: #484f58; cursor: not-allowed; }
        
        #console {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            background-color: #0d1117;
        }
        .log { margin-bottom: 4px; }
        .log-info { color: var(--text-color); }
        .log-success { color: var(--success-color); }
        .log-error { color: var(--error-color); }
        .log-warn { color: #d29922; }
        .log-system { color: var(--accent-color); font-weight: bold; }
        .progress-bar {
            width: 100%;
            background-color: #21262d;
            height: 4px;
            margin-top: 5px;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.2s;
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <input type="text" id="urlInput" placeholder="Enter URL to deep clone" value="https://s12eh1dx2vs1-d.space.z.ai/">
        <button id="startBtn" onclick="startDeepScan()">START DEEP SCAN & BUILD</button>
    </div>

    <div id="console">
        <div class="log log-system">SYSTEM READY [Deep Scan Module v3.0]</div>
        <div class="log log-info">Awaiting command...</div>
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
    </div>

    <script>
        const consoleEl = document.getElementById('console');
        const startBtn = document.getElementById('startBtn');
        const urlInput = document.getElementById('urlInput');
        const progressFill = document.getElementById('progress');

        // Helper for logging
        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `log log-${type}`;
            line.textContent = `> ${message}`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function setProgress(percent) {
            progressFill.style.width = `${percent}%`;
        }

        function clearConsole() {
            consoleEl.innerHTML = '';
        }

        async function startDeepScan() {
            const url = urlInput.value.trim();
            if (!url) return;

            startBtn.disabled = true;
            clearConsole();
            log("Initializing Deep Scan Algorithm...", "system");
            setProgress(5);

            try {
                const proxy = 'https://api.allorigins.win/raw?url=';
                const base = new URL(url);
                const zip = new JSZip();
                const publicFolder = zip.folder("public");

                // 1. Fetch Main Page
                log(`Target: ${url}`, "info");
                const mainRes = await fetch(proxy + encodeURIComponent(url));
                if (!mainRes.ok) throw new Error("Connection failed");
                
                const mainHtml = await mainRes.text();
                const mainDoc = new DOMParser().parseFromString(mainHtml, 'text/html');
                
                // Fix Base URL for assets
                const baseTag = mainDoc.createElement('base');
                baseTag.href = base.origin;
                mainDoc.head.prepend(baseTag);

                setProgress(20);

                // 2. Deep Scan Internal Links
                log("Scanning internal links (Depth: 1)...", "system");
                const links = new Set();
                mainDoc.querySelectorAll('a[href]').forEach(a => {
                    try {
                        const href = a.getAttribute('href');
                        const absUrl = new URL(href, base);
                        // Only scan same-origin internal links
                        if (absUrl.origin === base.origin && (absUrl.pathname.endsWith('/') || absUrl.pathname.endsWith('.html'))) {
                            links.add(absUrl.href);
                        }
                    } catch (e) {}
                });
                
                log(`Found ${links.size} internal pages to clone.`, "info");

                // 3. Download Resources & Pages
                const assets = new Map(); // URL -> filename
                
                // Extract assets from Main Page
                extractAssets(mainDoc, assets, base);
                
                // Fetch Internal Pages
                let processedLinks = 0;
                const linkPromises = Array.from(links).map(async link => {
                    try {
                        const res = await fetch(proxy + encodeURIComponent(link));
                        const text = await res.text();
                        const subDoc = new DOMParser().parseFromString(text, 'text/html');
                        
                        // Save page
                        const pageName = new URL(link).pathname.replace(/^\/|\/$/g, '') || 'index';
                        const fileName = pageName.endsWith('.html') ? pageName : `${pageName}.html`;
                        
                        // Extract assets from sub-pages too
                        extractAssets(subDoc, assets, base);
                        
                        // Rewrite links for local consistency (basic)
                        subDoc.querySelectorAll('a[href]').forEach(a => {
                            const h = a.getAttribute('href');
                            if (h.startsWith('/') || h.startsWith(base.origin)) {
                                try {
                                   const u = new URL(h, base);
                                   const localName = u.pathname.replace(/^\/|\/$/g, '') || 'index';
                                   a.href = localName.endsWith('.html') ? localName : `${localName}.html`;
                                } catch(e){}
                            }
                        });

                        publicFolder.file(fileName, subDoc.documentElement.outerHTML);
                        log(`Cloned Page: ${fileName}`, "success");
                    } catch (e) {
                        log(`Skipped Link: ${link}`, "warn");
                    }
                    processedLinks++;
                    setProgress(20 + (processedLinks / links.size) * 40);
                });

                await Promise.all(linkPromises);

                // 4. Download Assets
                log(`Downloading ${assets.size} unique assets...`, "system");
                let downloadedCount = 0;
                const assetPromises = Array.from(assets.entries()).map(async ([assetUrl, fileName]) => {
                    try {
                        const res = await fetch(proxy + encodeURIComponent(assetUrl));
                        const blob = await res.blob();
                        publicFolder.file(fileName, blob);
                        log(`Downloaded: ${fileName}`, "success");
                    } catch (e) {
                        log(`Asset Failed: ${fileName}`, "warn");
                    }
                    downloadedCount++;
                    setProgress(60 + (downloadedCount / assets.size) * 20);
                });

                await Promise.all(assetPromises);

                // 5. Check Missing Files
                log("Verifying build integrity...", "system");
                const missingFiles = [];
                
                // Check for Favicon
                if (!assets.has(`${base.origin}/favicon.ico`)) {
                    missingFiles.push({ url: `${base.origin}/favicon.ico`, name: 'favicon.ico' });
                }
                
                // Attempt to download missing standard files
                for (const file of missingFiles) {
                    try {
                        const res = await fetch(proxy + encodeURIComponent(file.url));
                        if (res.ok) {
                            publicFolder.file(file.name, await res.blob());
                            log(`Recovered Missing File: ${file.name}`, "success");
                        }
                    } catch (e) {}
                }

                // Save Main Index
                publicFolder.file("index.html", mainDoc.documentElement.outerHTML);

                // 6. Generate Node.js Build
                log("Constructing Build Environment...", "system");
                generateNodeBuild(zip);

                // 7. Generate Zip
                log("Packaging application...", "info");
                setProgress(95);
                const content = await zip.generateAsync({ type: "blob" });
                
                saveAs(content, `deep-clone-${Date.now()}.zip`);
                setProgress(100);
                log("Build Generated Successfully!", "system");

            } catch (err) {
                log(`CRITICAL ERROR: ${err.message}`, "error");
            } finally {
                startBtn.disabled = false;
            }
        }

        function extractAssets(doc, assets, base) {
            // Scan Images, Scripts, Stylesheets
            const selectors = [
                { tag: 'img', attr: 'src' },
                { tag: 'script', attr: 'src' },
                { tag: 'link', attr: 'href' }, // CSS, Icons
                { tag: 'source', attr: 'src' },
                { tag: 'video', attr: 'poster' }
            ];

            selectors.forEach(({ tag, attr }) => {
                doc.querySelectorAll(`${tag}[${attr}]`).forEach(el => {
                    const val = el.getAttribute(attr);
                    if (val && !val.startsWith('data:')) {
                        try {
                            const abs = new URL(val, base);
                            // Clean filename
                            let fileName = abs.pathname.split('/').pop().split('?')[0];
                            if (!fileName) fileName = `asset_${Math.random().toString(36).substr(2, 5)}`;
                            
                            assets.set(abs.href, fileName);
                            el.setAttribute(attr, fileName); // Rewrite path
                        } catch (e) {}
                    }
                });
            });
        }

        function generateNodeBuild(zip) {
            // 1. package.json
            const pJson = {
                name: "deep-cloned-app",
                version: "1.0.0",
                description: "Auto-generated deployment package",
                main: "server.js",
                scripts: {
                    start: "node server.js",
                    dev: "nodemon server.js",
                    install: "npm install"
                },
                engines: { node: ">=12.0.0 <=17.9.1" },
                devDependencies: { nodemon: "^2.0.15" }
            };
            zip.file("package.json", JSON.stringify(pJson, null, 2));

            // 2. .gitignore
            zip.file(".gitignore", `node_modules/\n.env\n.DS_Store\n*.log`);

            // 3. server.js
            const serverJs = `
const http = require('http');
const fs = require('fs');
const path = require('path');

const PORT = 3000;
const ROOT = path.join(__dirname, 'public');

const MIME = {
    '.html': 'text/html', '.css': 'text/css', '.js': 'application/javascript',
    '.png': 'image/png', '.jpg': 'image/jpeg', '.ico': 'image/x-icon',
    '.svg': 'image/svg+xml', '.json': 'application/json'
};

const server = http.createServer((req, res) => {
    let file = path.join(ROOT, req.url === '/' ? 'index.html' : req.url);
    const ext = path.extname(file).toLowerCase();
    
    // Security: Prevent directory traversal
    if (!file.startsWith(ROOT)) { res.writeHead(403); return res.end('Forbidden'); }

    fs.readFile(file, (err, data) => {
        if (err) {
            // Serve 404 if missing, but try to serve index.html for SPA routing
            fs.readFile(path.join(ROOT, '404.html'), (e, custom404) => {
                res.writeHead(404, { 'Content-Type': 'text/html' });
                res.end(custom404 || 'Not Found');
            });
        } else {
            res.writeHead(200, { 'Content-Type': MIME[ext] || 'text/plain' });
            res.end(data);
        }
    });
});

server.listen(PORT, () => console.log(\`Running on http://localhost:\${PORT}\`));
            `;
            zip.file("server.js", serverJs.trim());

            // 4. 404.html (Missing file completion)
            const notFound = `<!DOCTYPE html><html><body><h1>404 - Not Found</h1><p>The cloned page was not found.</p></body></html>`;
            zip.folder("public").file("404.html", notFound);
        }
    </script>
</body>
</html>
