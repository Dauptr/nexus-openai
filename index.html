<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NEXUS OS - Unlimited Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://js.puter.com/v2/"></script>
  <style>
    :root {
      --primary: #6366f1; --primary-light: #818cf8;
      --accent: #ec4899; --accent-light: #f472b6;
      --bg-dark: #050507; --bg-card: rgba(20, 20, 25, 0.6);
      --glass: rgba(255,255,255,0.03); --glass-border: rgba(255,255,255,0.08);
      --text-main: #f8fafc; --text-muted: #94a3b8;
      --success: #10b981; --danger: #ef4444;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); }

    #app-shell { display: flex; height: 100%; width: 100%; }
    
    /* Sidebar */
    .sidebar { 
      width: 240px; height: 100%; background: rgba(10, 10, 15, 0.95); border-right: 1px solid var(--glass-border); 
      display: flex; flex-direction: column; padding: 1.5rem; z-index: 100; transition: transform 0.3s ease;
      position: fixed; left: 0; top: 0; backdrop-filter: blur(20px);
    }
    .brand { font-family: 'JetBrains Mono', monospace; font-size: 1.2rem; font-weight: 700; margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem; }
    .brand::before { content: ''; width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); }
    
    .nav-item { 
      display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 8px; color: var(--text-muted); 
      cursor: pointer; transition: all 0.2s; margin-bottom: 4px; font-size: 0.85rem; font-weight: 500;
    }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
    .nav-item.active { background: rgba(99, 102, 241, 0.15); color: var(--primary-light); }

    /* Main Content */
    .main-content { flex: 1; margin-left: 240px; height: 100%; display: flex; flex-direction: column; background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.05), transparent 40%); }
    .topbar { height: 60px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; background: rgba(5,5,7,0.8); backdrop-filter: blur(10px); z-index: 50; flex-shrink: 0; }
    .page-container { flex: 1; padding: 2rem; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; }

    /* Components */
    .card { background: var(--bg-card); border: 1px solid var(--glass-border); border-radius: 20px; padding: 2rem; backdrop-filter: blur(10px); width: 100%; max-width: 650px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    
    .btn { 
      padding: 12px 24px; border-radius: 10px; border: none; font-family: inherit; font-size: 0.9rem; 
      font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
    .btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); }
    .btn-ghost { background: rgba(255,255,255,0.03); color: var(--text-muted); border: 1px solid var(--glass-border); }
    
    /* FIX: Added style for active ghost buttons (Style Selection) */
    .btn-ghost.active { 
      border-color: var(--primary-light); 
      color: var(--primary-light); 
      background: rgba(99, 102, 241, 0.1); 
    }

    .input-field { 
      width: 100%; padding: 14px 18px; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); 
      border-radius: 12px; color: var(--text-main); font-family: inherit; font-size: 0.95rem; outline: none; transition: border-color 0.2s;
    }
    .input-field:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }

    /* Tabs & Styles */
    .source-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 10px; }
    .source-tab { flex: 1; padding: 10px; text-align: center; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; color: var(--text-muted); transition: all 0.2s; border: none; background: none; }
    .source-tab.active { background: var(--success); color: white; box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3); }

    .progress-container { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 1rem; overflow: hidden; display: none; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: width 0.1s; }
    
    /* Result Area */
    .result-area { margin-top: 2rem; border-radius: 16px; overflow: hidden; position: relative; background: #111; min-height: 300px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--glass-border); flex-direction: column; gap: 1rem; }
    .result-image { width: 100%; height: auto; display: block; }
    .result-actions { display: flex; gap: 0.5rem; margin-top: 1rem; width: 100%; }
    
    .badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; margin-left: 4px; vertical-align: middle; background: rgba(255,255,255,0.1); color: var(--text-muted); }
    
    .hidden { display: none !important; }
    
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); position: absolute; }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0; }
      .page-container { padding: 1rem; align-items: flex-start; }
    }
  </style>
</head>
<body>

<div id="app-shell">
  <aside class="sidebar" id="sidenav">
    <div class="brand">NEXUS</div>
    
    <div class="nav-item active" data-nav="create">
      <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14m-7-7h14"/></svg>
      Create Image
    </div>
    <div class="nav-item" data-nav="database">
      <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 7v10c0 2 4 4 8 4s8-2 8-4V7M4 7c0 2 4 4 8 4s8-2 8-4M4 7c0-2 4-4 8-4s8 2 8 4"/></svg>
      Database
    </div>

    <div style="margin-top:auto; padding-top:1rem; border-top: 1px solid var(--glass-border);">
      <div class="text-xs text-muted" style="display:flex; align-items:center; gap:0.5rem;">
        <span style="width:6px; height:6px; background:var(--success); border-radius:50%; display:inline-block;"></span>
        Unlimited Mode Active
      </div>
    </div>
  </aside>

  <main class="main-content" id="main-area">
    <header class="topbar">
      <div style="display:flex; align-items:center; gap:1rem;">
        <button class="btn btn-ghost" id="toggle-nav" style="padding: 8px;">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <div style="font-weight:600" id="page-title">CREATE</div>
      </div>
    </header>

    <div class="page-container" id="app-root"></div>
  </main>
</div>

<script>
  // ================== STATE ==================
  const State = {
    nav: 'create',
    create: {
      prompt: '', 
      style: 'photorealistic', 
      source: 'real',
      result: null
    }
  };

  // ================== UTILITIES ==================
  const $ = (id) => document.getElementById(id);
  const $all = (sel) => document.querySelectorAll(sel);

  // ================== ROUTER ==================
  const Router = {
    init: () => {
      $all('.nav-item').forEach(el => {
        el.addEventListener('click', () => {
          State.nav = el.dataset.nav;
          Router.updateUI();
          Router.loadPage();
          if (window.innerWidth < 768) $('sidenav').classList.remove('open');
        });
      });
      $('toggle-nav').addEventListener('click', () => $('sidenav').classList.toggle('open'));
    },
    updateUI: () => {
      $all('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.nav === State.nav));
      $('page-title').textContent = State.nav.toUpperCase();
    },
    loadPage: () => {
      const pages = { 'create': CreatePage, 'database': DatabasePage };
      $('app-root').innerHTML = pages[State.nav]?.render() || '';
      pages[State.nav]?.init?.();
    }
  };

  // ================== CREATE PAGE ==================
  const CreatePage = {
    render: () => `
      <div class="card">
        <h2 style="margin-bottom:0.5rem; text-align:center; font-size:1.2rem;">Unlimited Creation</h2>
        <div style="text-align:center; color:var(--text-muted); font-size:0.8rem; margin-bottom:1.5rem;">No registration required</div>

        <!-- Source Selection -->
        <div class="source-tabs">
          <button class="source-tab ${State.create.source === 'real' ? 'active' : ''}" data-source="real">
            Real Photos <span class="badge">Instant</span>
          </button>
          <button class="source-tab ${State.create.source === 'ai' ? 'active' : ''}" data-source="ai">
            AI Art <span class="badge">Free</span>
          </button>
        </div>
        
        <!-- Styles -->
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-bottom:1.5rem;">
          <button class="btn btn-ghost ${State.create.style === 'photorealistic' ? 'active' : ''}" style="padding:8px; font-size:0.8rem;" data-style="photorealistic">Photo</button>
          <button class="btn btn-ghost ${State.create.style === 'anime' ? 'active' : ''}" style="padding:8px; font-size:0.8rem;" data-style="anime">Anime</button>
          <button class="btn btn-ghost ${State.create.style === '3d' ? 'active' : ''}" style="padding:8px; font-size:0.8rem;" data-style="3d">3D</button>
        </div>

        <!-- Prompt -->
        <textarea id="prompt-input" class="input-field" style="height:100px; resize:none; margin-bottom:1rem;" placeholder="Describe your vision (e.g., 'Sunset over mountains')">${State.create.prompt}</textarea>

        <!-- Generate Button -->
        <button id="generate-btn" class="btn btn-primary" style="width:100%; padding:14px;">
          ‚ú® Generate Image
        </button>

        <!-- Progress -->
        <div class="progress-container" id="progress-box">
          <div class="progress-bar" id="progress-bar"></div>
        </div>

        <!-- Result Container -->
        <div id="result-container" class="hidden">
          <div class="result-area">
            <!-- Placeholder while loading -->
            <div id="loading-indicator" class="hidden" style="color:var(--text-muted);">Loading image...</div>
            
            <img id="result-image" class="result-image" style="display:none;">
            
            <!-- Fallback if image fails to render in DOM -->
            <div id="fallback-link" class="hidden" style="padding:1rem; text-align:center;">
               <p style="margin-bottom:1rem; color:var(--text-muted);">If image doesn't appear, click below:</p>
               <a id="view-link" href="#" target="_blank" class="btn btn-primary">View Image</a>
            </div>
          </div>
          <div class="result-actions">
            <button class="btn btn-ghost" style="flex:1" onclick="CreatePage.download()">‚¨áÔ∏è Open</button>
            <button class="btn btn-primary" style="flex:1" onclick="CreatePage.save()">üíæ Save</button>
          </div>
        </div>
      </div>
    `,

    init: () => {
      // Source Tabs
      $all('.source-tab').forEach(btn => {
        btn.onclick = () => {
          State.create.source = btn.dataset.source;
          Router.loadPage();
        };
      });

      // Style Buttons
      $all('[data-style]').forEach(btn => {
        btn.onclick = () => {
          State.create.style = btn.dataset.style;
          $all('[data-style]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        };
      });

      // Generate Logic
      $('generate-btn').onclick = () => {
        const prompt = $('prompt-input').value.trim();
        if(!prompt) {
            alert("Please enter a description.");
            return;
        }

        const btn = $('generate-btn');
        const progressBox = $('progress-box');
        const progressBar = $('progress-bar');
        const resultContainer = $('result-container');
        const resultImage = $('result-image');
        const loadingIndicator = $('loading-indicator');
        const fallbackLink = $('fallback-link');
        const viewLink = $('view-link');

        State.create.prompt = prompt;
        
        // UI Loading
        btn.disabled = true;
        btn.innerHTML = '<span style="width:16px; height:16px; border:2px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation: spin 1s linear infinite;"></span> Generating...';
        
        // Reset UI
        progressBox.style.display = 'block';
        resultContainer.classList.remove('hidden');
        resultImage.style.display = 'none';
        fallbackLink.classList.add('hidden');
        loadingIndicator.classList.remove('hidden');
        
        // Progress Simulation
        let width = 0;
        const interval = setInterval(() => {
          width += 5;
          if(width > 90) width = 90;
          progressBar.style.width = width + '%';
        }, 100);

        // Construct URL
        let url = null;
        const source = State.create.source;
        const style = State.create.style;
        
        // 1. REAL PHOTOS (Replaced deprecated Unsplash with LoremFlickr)
        if(source === 'real') {
            // FIX: source.unsplash.com is deprecated. Using loremplickr for keyword search.
            // Format: https://loremflickr.com/width/height/search_terms
            url = `https://loremflickr.com/1280/720/${encodeURIComponent(prompt)}?random=${Date.now()}`;
        }
        // 2. AI ART (Pollinations)
        else if(source === 'ai') {
            const stylePrompt = `${prompt}, ${style} style, high quality`;
            url = `https://image.pollinations.ai/prompt/${encodeURIComponent(stylePrompt)}?width=1280&height=720&nologo=true&seed=${Date.now()}`;
        }

        if(!url) {
            clearInterval(interval);
            alert("Error generating URL");
            return;
        }

        // Set the state
        State.create.result = url;
        
        // Set fallback link immediately
        viewLink.href = url;
        fallbackLink.classList.remove('hidden'); // Show fallback just in case

        // Load Image directly into DOM
        const imgLoader = new Image();
        
        imgLoader.onload = () => {
            clearInterval(interval);
            progressBar.style.width = '100%';
            
            loadingIndicator.classList.add('hidden');
            resultImage.src = url;
            resultImage.style.display = 'block';
            
            btn.disabled = false;
            btn.innerHTML = '‚ú® Generate Image';
        };

        imgLoader.onerror = () => {
            clearInterval(interval);
            loadingIndicator.innerHTML = "<span style='color:var(--danger)'>Error loading image. Check connection.</span>";
            btn.disabled = false;
            btn.innerHTML = '‚ú® Generate Image';
        };

        imgLoader.src = url;
      };
    },

    download: () => {
      if(!State.create.result) return;
      // Open in new tab is the most reliable way for cross-origin images
      window.open(State.create.result, '_blank');
    },

    save: async () => {
      if(!State.create.result) return;
      try {
        let db = await puter.kv.get('nexus_img_db') || [];
        db.unshift({ url: State.create.result, prompt: State.create.prompt, date: new Date().toISOString() });
        await puter.kv.set('nexus_img_db', db);
        alert("Saved to Cloud Database!");
      } catch(e) {
        console.error(e);
        alert("Could not save to cloud. Try again.");
      }
    }
  };

  // ================== DATABASE PAGE ==================
  const DatabasePage = {
    render: () => `
      <div class="card">
        <h2 style="margin-bottom:1.5rem; text-align:center;">Saved Images</h2>
        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:1rem;" id="db-grid">
          <div class="text-muted" style="text-align:center; width:100%">Loading...</div>
        </div>
      </div>
    `,
    init: async () => {
      const grid = $('db-grid');
      try {
        const db = await puter.kv.get('nexus_img_db') || [];
        if(db.length === 0) {
          grid.innerHTML = '<p class="text-muted" style="text-align:center; width:100%">No saved images yet.</p>';
        } else {
          grid.innerHTML = db.map(img => `
            <div style="background:#000; border-radius:8px; overflow:hidden; border:1px solid var(--glass-border); cursor:pointer;" onclick="window.open('${img.url}', '_blank')">
              <img src="${img.url}" style="width:100%; height:150px; object-fit:cover;">
              <div style="padding:8px;">
                <div style="font-size:0.7rem; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${img.prompt}</div>
              </div>
            </div>
          `).join('');
        }
      } catch(e) {
        grid.innerHTML = '<p class="text-muted" style="text-align:center; width:100%">Enable cloud storage to save images.</p>';
      }
    }
  };

  // ================== INIT ==================
  window.addEventListener('load', () => {
    Router.init();
    Router.loadPage();
  });
  
  window.CreatePage = CreatePage;

</script>
</body>
</html>
