<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NEXUS OS V15.0 | Fashion OS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://js.puter.com/v2/" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    :root {
      --primary: #8a2be2; --primary-light: #a855f7;
      --accent: #ec4899; --accent-light: #f472b6;
      --bg-dark: #050505; --bg-card: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.05); --glass-border: rgba(255,255,255,0.1);
      --text-main: #ffffff; --text-muted: #94a3b8;
      --success: #10b981; --danger: #ef4444;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); }
    
    /* 3D Background */
    #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    .content-layer { position: relative; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; }
    
    /* Auth Screen */
    .auth-container { display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px; }
    .auth-card {
      width: 100%; max-width: 420px; padding: 3rem;
      background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid var(--glass-border); border-radius: 24px;
      backdrop-filter: blur(20px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      animation: fadeUp 0.6s ease-out;
    }
    .auth-logo { font-family: 'Space Grotesk', sans-serif; font-size: 2.5rem; font-weight: 700; background: linear-gradient(to right, var(--primary-light), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
    .auth-subtitle { color: var(--text-muted); margin-bottom: 2.5rem; font-size: 0.95rem; }
    
    .form-group { margin-bottom: 1.5rem; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .form-input {
      width: 100%; padding: 14px 18px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
      border-radius: 12px; color: #fff; font-size: 1rem; transition: all 0.3s;
    }
    .form-input:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.1); }
    
    .btn {
      width: 100%; padding: 16px; border: none; border-radius: 12px;
      font-family: 'Space Grotesk', sans-serif; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.1em;
    }
    .btn-primary { background: linear-gradient(135deg, var(--primary-light), var(--accent)); color: #fff; box-shadow: 0 10px 20px rgba(168, 85, 247, 0.3); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(168, 85, 247, 0.4); }
    .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); }
    .btn-danger { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: var(--danger); }
    
    /* Main App Layout */
    .app-shell { display: flex; height: 100%; overflow: hidden; }
    
    /* Sidebar */
    .sidebar {
      width: 280px; background: rgba(0,0,0,0.4); border-right: 1px solid var(--glass-border);
      display: flex; flex-direction: column; padding: 1.5rem; transition: transform 0.3s;
    }
    .sidebar-header { margin-bottom: 2rem; }
    .brand { font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 700; color: #fff; }
    
    .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 0.5rem; }
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 14px 16px;
      border-radius: 10px; color: var(--text-muted); text-decoration: none;
      transition: all 0.2s; font-weight: 500; cursor: pointer;
    }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .nav-item.active { background: rgba(168, 85, 247, 0.15); color: var(--primary-light); border-left: 3px solid var(--primary-light); }
    
    .user-profile { padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 12px; margin-top: auto; }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--accent)); display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .user-name { font-weight: 600; font-size: 0.9rem; }
    .user-role { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
    
    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .topbar {
      height: 70px; border-bottom: 1px solid var(--glass-border); background: rgba(0,0,0,0.2);
      display: flex; align-items: center; justify-content: space-between; padding: 0 2rem;
    }
    .page-title { font-family: 'Space Grotesk', sans-serif; font-size: 1.25rem; font-weight: 600; }
    .topbar-actions { display: flex; gap: 1rem; align-items: center; }
    
    .page-container { flex: 1; padding: 2rem; overflow-y: auto; scroll-behavior: smooth; }
    
    /* Grid & Cards */
    .grid { display: grid; gap: 1.5rem; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    
    .glass-card {
      background: var(--glass); border: 1px solid var(--glass-border); border-radius: 20px;
      padding: 1.5rem; transition: transform 0.3s, box-shadow 0.3s;
    }
    .glass-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    
    /* Chat UI */
    .chat-layout { display: flex; gap: 1.5rem; height: calc(100% - 1rem); }
    .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--glass); border-radius: 20px; overflow: hidden; }
    .chat-messages { flex: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }
    .msg { max-width: 70%; padding: 1rem 1.25rem; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; position: relative; }
    .msg-in { background: rgba(255,255,255,0.05); align-self: flex-start; border-bottom-left-radius: 4px; }
    .msg-out { background: linear-gradient(135deg, var(--primary), var(--accent)); align-self: flex-end; border-bottom-right-radius: 4px; }
    .msg-ai { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); align-self: center; font-size: 0.85rem; color: var(--success); max-width: 90%; text-align: center; }
    .msg-meta { font-size: 0.7rem; opacity: 0.7; margin-top: 0.5rem; display: block; }
    
    .chat-input-area { padding: 1rem; border-top: 1px solid var(--glass-border); display: flex; gap: 1rem; }
    .chat-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 12px; padding: 0 1rem; color: #fff; }
    
    /* Art Studio */
    .studio-grid { display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem; height: 100%; }
    .studio-controls { display: flex; flex-direction: column; gap: 1rem; }
    .prompt-box { height: 120px; resize: none; background: rgba(0,0,0,0.4); border-radius: 12px; padding: 1rem; color: #fff; }
    .style-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .chip { padding: 6px 12px; background: rgba(255,255,255,0.05); border-radius: 20px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
    .chip.active, .chip:hover { border-color: var(--primary-light); color: var(--primary-light); background: rgba(168, 85, 247, 0.1); }
    
    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
    .gallery-item { position: relative; aspect-ratio: 1; border-radius: 12px; overflow: hidden; background: #000; }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .gallery-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); opacity: 0; transition: opacity 0.3s; display: flex; align-items: flex-end; padding: 1rem; }
    .gallery-item:hover .gallery-overlay { opacity: 1; }
    .gallery-item:hover img { transform: scale(1.1); }
    
    /* Admin Console */
    .admin-table { width: 100%; border-collapse: collapse; }
    .admin-table th { text-align: left; padding: 1rem; border-bottom: 1px solid var(--glass-border); color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }
    .admin-table td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
    .status-active { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .status-banned { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    
    /* Utilities */
    .hidden { display: none !important; }
    .text-gradient { background: linear-gradient(to right, var(--primary-light), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .text-sm { font-size: 0.85rem; }
    .text-muted { color: var(--text-muted); }
    .mb-1 { margin-bottom: 0.5rem; }
    .p-1 { padding: 0.5rem; }
    
    /* Animations */
    @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; } }
    
    /* Mobile */
    @media (max-width: 768px) {
      .sidebar { position: fixed; left: 0; top: 0; height: 100%; z-index: 100; transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .studio-grid { grid-template-columns: 1fr; }
      .chat-layout { flex-direction: column; }
    }
  </style>
</head>
<body>
  <canvas id="bg-canvas"></canvas>
  
  <div class="content-layer" id="app-root"></div>

  <script>
    // ================== APP STATE & CONFIG ==================
    const CONFIG = {
      APP_NAME: "NEXUS",
      ADMIN_USER: "admin",
      ADMIN_PASS: "dauptr",
      CHAT_CHANNEL_ID: "nexus_os_v15_global_chat"
    };

    const Store = {
      get: (k) => JSON.parse(localStorage.getItem(k) || 'null'),
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
      users: () => Store.get('nexus_users') || [{ u: CONFIG.ADMIN_USER, p: CONFIG.ADMIN_PASS, r: 'admin', s: 'active' }], // Default admin
      saveUsers: (d) => Store.set('nexus_users', d),
      currentUser: () => Store.get('nexus_curr_user')
    };

    // Initialize default users if not exist
    if(!Store.get('nexus_users')) Store.saveUsers([{ u: CONFIG.ADMIN_USER, p: CONFIG.ADMIN_PASS, r: 'admin', s: 'active' }]);

    const State = {
      page: 'login', // login, app
      activeNav: 'dashboard',
      user: Store.currentUser(),
      users: [], // online users or admin list
      chat: { messages: [], input: '' },
      studio: { 
        prompt: '', history: [], loading: false, 
        style: 'photorealistic', 
        styles: ['photorealistic', 'anime', '3d-render', 'cyberpunk', 'oil-painting']
      }
    };

    // ================== THREE.JS 3D BACKGROUND ==================
    const initBG = () => {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

      // Lights
      const ambient = new THREE.AmbientLight(0x404040, 2);
      scene.add(ambient);
      const pointLight = new THREE.PointLight(0xa855f7, 2, 100);
      pointLight.position.set(10, 10, 10);
      scene.add(pointLight);

      // Objects
      const icoGeo = new THREE.IcosahedronGeometry(2, 1);
      const icoMat = new THREE.MeshPhongMaterial({ color: 0x8a2be2, wireframe: true, transparent: true, opacity: 0.8 });
      const ico = new THREE.Mesh(icoGeo, icoMat);
      scene.add(ico);

      const torusGeo = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
      const torusMat = new THREE.MeshNormalMaterial({ wireframe: true });
      const torus = new THREE.Mesh(torusGeo, torusMat);
      torus.position.set(5, 0, -5);
      scene.add(torus);

      // Particles
      const particles = new THREE.BufferGeometry();
      const vertices = [];
      for(let i=0; i<2000; i++) vertices.push((Math.random() - 0.5) * 50, (Math.random() - 0.5) * 50, (Math.random() - 0.5) * 50);
      particles.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
      const pMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.05, transparent: true, opacity: 0.6 });
      const pSys = new THREE.Points(particles, pMat);
      scene.add(pSys);

      camera.position.z = 5;

      const animate = () => {
        requestAnimationFrame(animate);
        ico.rotation.x += 0.003; ico.rotation.y += 0.005;
        torus.rotation.x += 0.01; torus.rotation.y += 0.005;
        pSys.rotation.y += 0.001;
        renderer.render(scene, camera);
      };
      animate();

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    };

    // ================== AI ENGINE ==================
    const AI = {
      ask: async (prompt) => {
        if(!window.puter || !window.puter.ai) return "AI System initializing...";
        try {
          const res = await window.puter.ai.chat(prompt);
          return typeof res === 'string' ? res : res.message?.content || "Processing complete.";
        } catch(e) { return "Error: " + e.message; }
      },
      image: async (prompt) => {
        if(!window.puter || !window.puter.ai) throw new Error("AI not ready");
        const res = await window.puter.ai.txt2img(prompt + ", hyper detailed, 8k, masterpiece");
        if(res instanceof HTMLImageElement) return res.src;
        if(res.url) return res.url;
        throw new Error("Image generation failed");
      }
    };

    // ================== CHAT SYSTEM ==================
    // Simulating global chat with BroadcastChannel for demo.
    // In production, replace message sending with Firebase/Supabase API calls.
    const chatChannel = new BroadcastChannel(CONFIG.CHAT_CHANNEL_ID);
    
    chatChannel.onmessage = (ev) => {
      if(ev.data.type === 'msg') {
        if(State.user && ev.data.user !== State.user.u) {
          State.chat.messages.push({ ...ev.data, mine: false });
          render();
        }
      }
    };

    const Chat = {
      send: (text) => {
        if(!text.trim()) return;
        
        // AI Command detection
        if(text.startsWith('/ai ')) {
           const cmd = text.substring(4);
           State.chat.messages.push({ user: 'NEXUS AI', text: 'Thinking...', mine: false, meta: new Date().toLocaleTimeString(), ai: true });
           render();
           AI.ask(cmd).then(res => {
             State.chat.messages[State.chat.messages.length-1].text = res;
             render();
           });
           return;
        }

        const msg = { user: State.user.u, text, meta: new Date().toLocaleTimeString(), mine: true };
        State.chat.messages.push(msg);
        chatChannel.postMessage({ type: 'msg', ...msg });
        render();
      }
    };

    // ================== RENDER ENGINE ==================
    const render = () => {
      const root = document.getElementById('app-root');
      if(!State.user) {
        root.innerHTML = renderAuth();
      } else {
        root.innerHTML = renderApp();
      }
      bindEvents();
    };

    const renderAuth = () => `
      <div class="auth-container">
        <div class="auth-card">
          <div style="text-align:center">
            <div class="auth-logo">NEXUS</div>
            <div class="auth-subtitle">The Future of Operating Systems</div>
          </div>
          <div id="auth-form">
            <div class="form-group">
              <label class="form-label">Username</label>
              <input type="text" id="auth_u" class="form-input" placeholder="Enter username">
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" id="auth_p" class="form-input" placeholder="Enter password">
            </div>
            <button class="btn btn-primary" onclick="login()">Sign In</button>
            <div style="margin-top:1.5rem; text-align:center">
              <span class="text-muted text-sm">Don't have an account?</span>
              <button class="btn btn-secondary" style="margin-top:0.5rem" onclick="State.page='register'; render();">Create Account</button>
            </div>
          </div>
        </div>
      </div>
    `;

    const renderApp = () => `
      <div class="app-shell">
        <aside class="sidebar" id="sidebar">
          <div class="sidebar-header">
            <div class="brand">NEXUS</div>
            <div class="text-muted text-sm" style="margin-top:4px">v15.0 Fashion</div>
          </div>
          
          <nav class="nav-menu">
            <div class="nav-item ${State.activeNav === 'dashboard' ? 'active':''}" onclick="nav('dashboard')">
              <span>üè†</span> Dashboard
            </div>
            <div class="nav-item ${State.activeNav === 'chat' ? 'active':''}" onclick="nav('chat')">
              <span>üí¨</span> Network
            </div>
            <div class="nav-item ${State.activeNav === 'studio' ? 'active':''}" onclick="nav('studio')">
              <span>üé®</span> Art Studio
            </div>
             ${State.user.r === 'admin' ? `
             <div class="nav-item ${State.activeNav === 'admin' ? 'active':''}" onclick="nav('admin')">
              <span>üõ°Ô∏è</span> Admin Console
            </div>` : ''}
          </nav>

          <div class="user-profile">
            <div class="user-info">
              <div class="avatar">${State.user.u[0].toUpperCase()}</div>
              <div>
                <div class="user-name">${State.user.u}</div>
                <div class="user-role">${State.user.r}</div>
              </div>
            </div>
            <button class="btn btn-secondary" style="margin-top:1rem; padding:8px" onclick="logout()">Logout</button>
          </div>
        </aside>

        <main class="main-content">
          <div class="topbar">
            <div class="page-title">${State.activeNav.toUpperCase()}</div>
            <div class="topbar-actions">
              <button class="btn btn-secondary" style="padding:8px 12px" onclick="toggleSidebar()">‚ò∞</button>
            </div>
          </div>
          <div class="page-container">
            ${renderPage()}
          </div>
        </main>
      </div>
    `;

    const renderPage = () => {
      switch(State.activeNav) {
        case 'dashboard': return renderDashboard();
        case 'chat': return renderChat();
        case 'studio': return renderStudio();
        case 'admin': return renderAdmin();
        default: return renderDashboard();
      }
    };

    const renderDashboard = () => `
      <div class="grid grid-4">
        <div class="glass-card"><h3>System Status</h3><p class="text-gradient" style="font-size:2rem; margin-top:1rem">ONLINE</p></div>
        <div class="glass-card"><h3>Active Nodes</h3><p class="text-gradient" style="font-size:2rem; margin-top:1rem">1,204</p></div>
        <div class="glass-card"><h3>Latency</h3><p class="text-gradient" style="font-size:2rem; margin-top:1rem">12ms</p></div>
        <div class="glass-card"><h3>Security</h3><p class="text-gradient" style="font-size:2rem; margin-top:1rem">AES-512</p></div>
      </div>
      <div class="glass-card" style="margin-top:1.5rem">
        <h3>Welcome, ${State.user.u}</h3>
        <p class="text-muted" style="margin-top:0.5rem">The system is fully operational. New fashion updates available in Art Studio.</p>
      </div>
    `;

    const renderChat = () => `
      <div class="chat-layout">
        <div class="chat-main">
          <div class="chat-messages" id="msgs">
            ${State.chat.messages.map(m => `
              <div class="msg ${m.mine ? 'msg-out' : 'msg-in'} ${m.ai ? 'msg-ai' : ''}">
                ${!m.mine && !m.ai ? `<strong style="font-size:0.8em; color:var(--primary-light)">${m.user}</strong><br>` : ''}
                ${m.text}
                <span class="msg-meta">${m.meta}</span>
              </div>
            `).join('')}
          </div>
          <div class="chat-input-area">
            <input type="text" id="chat_i" class="chat-input" placeholder="Type a message... (Use /ai [prompt] for AI)" value="${State.chat.input}" oninput="State.chat.input=this.value">
            <button class="btn btn-primary" style="width:100px" onclick="Chat.send(State.chat.input); State.chat.input=''; render();">Send</button>
          </div>
        </div>
      </div>
    `;

    const renderStudio = () => `
      <div class="studio-grid">
        <div class="glass-card studio-controls">
          <h3 class="mb-1">Creation Tools</h3>
          <textarea class="prompt-box" id="p_box" placeholder="Describe your vision...">${State.studio.prompt}</textarea>
          
          <div class="style-chips">
            ${State.studio.styles.map(s => `
              <div class="chip ${State.studio.style === s ? 'active':''}" onclick="State.studio.style='${s}'; render()">${s}</div>
            `).join('')}
          </div>
          
          <button class="btn btn-primary" style="margin-top:1rem" onclick="generateArt()" id="gen_btn">
            ${State.studio.loading ? 'Generating...' : 'Generate'}
          </button>
          
          <div style="margin-top:1.5rem">
            <h4 class="text-muted mb-1">AI Assistant</h4>
            <button class="btn btn-secondary btn-small" style="width:100%" onclick="enhancePrompt()">‚ú® Enhance Prompt</button>
          </div>
        </div>
        
        <div class="glass-card" style="padding:1rem; overflow-y:auto">
          <h3 class="mb-1">Gallery</h3>
          <div class="gallery-grid">
            ${State.studio.history.map(img => `
              <div class="gallery-item">
                <img src="${img}">
                <div class="gallery-overlay">
                  <button class="btn btn-secondary btn-small" onclick="downloadImg('${img}')">‚¨áÔ∏è Save</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;

    const renderAdmin = () => `
      <div class="glass-card">
        <h3>User Management</h3>
        <p class="text-muted mb-1">Manage access and permissions.</p>
        <table class="admin-table">
          <thead><tr><th>User</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody>
            ${Store.users().map(u => `
              <tr>
                <td>${u.u}</td>
                <td>${u.r}</td>
                <td><span class="status-badge ${u.s === 'active' ? 'status-active' : 'status-banned'}">${u.s}</span></td>
                <td>
                  ${u.u !== 'admin' ? `
                    <button class="btn btn-secondary btn-small" onclick="toggleBan('${u.u}')">${u.s === 'active' ? 'Ban' : 'Unban'}</button>
                    <button class="btn btn-danger btn-small" onclick="deleteUser('${u.u}')">Delete</button>
                  ` : '<span class="text-muted">Protected</span>'}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;

    // ================== ACTIONS ==================
    
    window.nav = (p) => { State.activeNav = p; render(); };
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
    
    window.login = () => {
      const u = document.getElementById('auth_u').value;
      const p = document.getElementById('auth_p').value;
      const user = Store.users().find(x => x.u === u && x.p === p);
      if(user && user.s !== 'banned') {
        State.user = user;
        Store.set('nexus_curr_user', user);
        render();
      } else {
        alert(user ? 'User is banned.' : 'Invalid credentials');
      }
    };
    
    window.logout = () => { State.user = null; Store.set('nexus_curr_user', null); render(); };
    
    window.toggleBan = (u) => {
      let users = Store.users();
      const idx = users.findIndex(x => x.u === u);
      if(idx >= 0) users[idx].s = users[idx].s === 'active' ? 'banned' : 'active';
      Store.saveUsers(users);
      render();
    };
    
    window.deleteUser = (u) => {
      if(confirm("Delete user?")) {
        let users = Store.users().filter(x => x.u !== u);
        Store.saveUsers(users);
        render();
      }
    };
    
    window.generateArt = async () => {
      const prompt = document.getElementById('p_box').value;
      if(!prompt) return;
      State.studio.loading = true;
      render();
      try {
        const fullPrompt = `${prompt}, ${State.studio.style}, 8k resolution, highly detailed`;
        const url = await AI.image(fullPrompt);
        State.studio.history.unshift(url);
      } catch(e) { alert(e.message); }
      State.studio.loading = false;
      render();
    };
    
    window.enhancePrompt = async () => {
      const p = document.getElementById('p_box').value;
      if(!p) return;
      const res = await AI.ask(`Rewrite this image prompt to be more creative and detailed for an AI art generator. Return ONLY the prompt: "${p}"`);
      document.getElementById('p_box').value = res;
    };

    window.downloadImg = (url) => {
      const a = document.createElement('a'); a.href=url; a.download='nexus-art.png'; a.click();
    };

    const bindEvents = () => {
      // Auto-scroll chat
      const msgs = document.getElementById('msgs');
      if(msgs) msgs.scrollTop = msgs.scrollHeight;
      
      // Enter key for chat
      const ci = document.getElementById('chat_i');
      if(ci) ci.onkeydown = (e) => { if(e.key==='Enter'){ Chat.send(State.chat.input); State.chat.input=''; render(); } };
    };

    // ================== INIT ==================
    initBG();
    render();

  </script>
</body>
</html>
