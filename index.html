<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEXUS OS v9.0 - Robust Parser</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    :root {
      --cyan: #00f0ff; --magenta: #ff00aa; --green: #00ff88; --bg: #000001;
      --border: rgba(0, 240, 255, 0.3); --red: #ff4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Courier New', monospace; background: var(--bg); color: #e5e7eb; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    
    .container { width: 100%; max-width: 900px; padding: 20px; text-align: center; z-index: 2; }
    
    h1 { color: var(--cyan); text-shadow: 0 0 20px var(--cyan); margin-bottom: 10px; font-size: 2.5rem; letter-spacing: 2px; }
    
    .status-bar { 
      margin-bottom: 20px; font-size: 0.9rem; font-family: monospace;
      padding: 8px; border-radius: 4px; background: rgba(0,0,0,0.5); border: 1px solid var(--border);
    }
    .status-ok { color: var(--green); }
    .status-error { color: var(--red); border-color: var(--red); }

    .input-card { background: rgba(0, 20, 30, 0.9); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
    
    .prompt-input { width: 100%; padding: 15px; background: rgba(0,0,0,0.6); border: 1px solid var(--border); color: #fff; font-family: inherit; font-size: 16px; border-radius: 6px; margin-bottom: 15px; outline: none; }
    .prompt-input:focus { border-color: var(--cyan); }

    .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    button { padding: 12px 24px; border: none; cursor: pointer; font-family: inherit; font-weight: bold; transition: 0.2s; border-radius: 6px; font-size: 14px; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    
    .btn-primary { background: linear-gradient(135deg, var(--cyan), #00a0cc); color: #000; }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 240, 255, 0.4); }
    
    .btn-secondary { background: transparent; border: 1px solid var(--magenta); color: var(--magenta); }

    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 30px; }
    .gallery-item { aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 1px solid var(--magenta); background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
    .gallery-item.loading { border-style: dashed; animation: pulse 2s infinite; }
    .gallery-item.loading::after { content: "GENERATING..."; color: var(--cyan); font-size: 12px; }

    .debug-log { background: rgba(0, 5, 10, 0.9); border: 1px solid #333; padding: 10px; margin-top: 20px; font-size: 12px; color: #888; text-align: left; min-height: 60px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }

    .notification { position: fixed; top: 20px; right: 20px; background: var(--green); color: #000; padding: 10px 20px; border-radius: 4px; font-weight: bold; opacity: 0; transition: 0.3s; z-index: 100; }
    .notification.show { opacity: 1; }
    .notification.error { background: var(--red); color: #fff; }

    @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

    #particles { position: fixed; inset: 0; pointer-events: none; z-index: 1; }
  </style>
</head>
<body>
  <canvas id="particles"></canvas>

  <div class="container">
    <h1>NEXUS AI STUDIO</h1>
    
    <div id="systemStatus" class="status-bar status-error">Checking System...</div>

    <div class="input-card">
      <input type="text" id="promptInput" class="prompt-input" placeholder="Enter prompt (e.g. Futuristic city)">
      
      <div class="btn-group">
        <button id="createOneBtn" class="btn-primary" onclick="generateSingle()">CREATE (1)</button>
        <button id="createAllBtn" class="btn-secondary" onclick="generateAll()">CREATE ALL (3)</button>
      </div>
    </div>

    <div class="gallery" id="gallery"></div>
    <div class="debug-log" id="debugLog">Ready.</div>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    // --- 1. Helpers ---
    const $ = id => document.getElementById(id);
    const log = msg => { $('debugLog').innerText = msg; console.log(msg); };
    const notify = (msg, isError = false) => { 
      const n = $('notification'); 
      n.innerText = msg; 
      n.className = isError ? "notification show error" : "notification show";
      setTimeout(() => n.className = "notification", 4000);
    };

    // --- 2. System Checks ---
    function checkEnvironment() {
      const statusDiv = $('systemStatus');
      if (window.location.protocol === 'file:') {
        statusDiv.innerHTML = "ERROR: Run on Local Server (npm start)";
        statusDiv.className = "status-bar status-error";
        return false;
      }
      if (!window.puter) {
        statusDiv.innerHTML = "ERROR: AI Library blocked. Disable AdBlocker.";
        statusDiv.className = "status-bar status-error";
        return false;
      }
      statusDiv.innerHTML = "âœ“ SYSTEM ONLINE";
      statusDiv.className = "status-bar status-ok";
      return true;
    }

    // --- 3. Particles ---
    function initParticles() {
      const canvas = $('particles'); const ctx = canvas.getContext('2d');
      let w = canvas.width = innerWidth, h = canvas.height = innerHeight;
      const particles = Array.from({length: 50}, () => ({x:Math.random()*w, y:Math.random()*h, r:Math.random()*2, dx:(Math.random()-0.5)*.5, dy:(Math.random()-0.5)*.5}));
      function draw() {
        ctx.fillStyle = 'rgba(0, 0, 1, 0.2)'; ctx.fillRect(0, 0, w, h);
        ctx.fillStyle = '#00f0ff';
        particles.forEach(p => {
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
          p.x += p.dx; p.y += p.dy;
          if(p.x < 0 || p.x > w) p.dx *= -1; if(p.y < 0 || p.y > h) p.dy *= -1;
        });
        requestAnimationFrame(draw);
      }
      draw();
    }

    // --- 4. ROBUST PARSER (Fixes "Invalid Response") ---
    async function processResponse(response) {
      // DEBUG: Inspect what we got
      console.log("Parser Received:", response);
      log("Parsing response...");

      // CASE A: It's a standard HTTP Response object
      if (response instanceof Response) {
        // Try to check if it's an error message first
        const clone = response.clone();
        if (!response.ok) {
           const errText = await clone.text();
           throw new Error("Server Error: " + errText);
        }
        const blob = await response.blob();
        return URL.createObjectURL(blob);
      }

      // CASE B: It's a raw Blob
      if (response instanceof Blob) {
        return URL.createObjectURL(response);
      }

      // CASE C: It's a URL String
      if (typeof response === 'string') {
        if (response.startsWith('http') || response.startsWith('blob')) return response;
        // Might be a JSON string
        try {
            const json = JSON.parse(response);
            return extractUrlFromJson(json);
        } catch(e) {
            throw new Error("Response was string but not URL/JSON");
        }
      }

      // CASE D: It's a JSON Object (Common Fix)
      if (typeof response === 'object' && response !== null) {
        // Check for error message inside object
        if (response.error) {
             throw new Error(response.error.message || JSON.stringify(response.error));
        }
        
        // Try to find URL inside
        const url = extractUrlFromJson(response);
        if(url) return url;
      }

      throw new Error("Unknown Format: " + typeof response);
    }

    // Helper to hunt for URL inside JSON
    function extractUrlFromJson(obj) {
        if(!obj || typeof obj !== 'object') return null;
        // Check common keys
        if (obj.url) return obj.url;
        if (obj.image_url) return obj.image_url;
        if (obj.src) return obj.src;
        if (obj.link) return obj.link;
        if (obj.data && typeof obj.data === 'string' && obj.data.startsWith('http')) return obj.data;
        
        // Recursive search (depth 1)
        for(let key in obj) {
            if (typeof obj[key] === 'string' && obj[key].startsWith('http')) {
                return obj[key];
            }
        }
        return null;
    }

    async function createImage(prompt) {
      if (!window.puter) throw new Error("AI not initialized");
      const result = await window.puter.ai.txt2img(prompt);
      return await processResponse(result);
    }

    // --- 5. Actions ---
    async function generateSingle() {
      if (!checkEnvironment()) return;

      const prompt = $('promptInput').value.trim();
      if (!prompt) return notify("Enter a prompt", true);

      const btn = $('createOneBtn');
      btn.disabled = true; btn.innerText = "WORKING...";
      log("Sending prompt to AI...");

      try {
        const url = await createImage(prompt);
        addImageToGallery(url);
        notify("Image Created");
        log("Success.");
      } catch (e) {
        log("Error: " + e.message); 
        notify("Failed (see log)", true);
      } finally {
        btn.disabled = false; btn.innerText = "CREATE (1)";
      }
    }

    async function generateAll() {
      if (!checkEnvironment()) return;

      const prompt = $('promptInput').value.trim();
      if (!prompt) return notify("Enter a prompt", true);

      const btn = $('createAllBtn');
      btn.disabled = true; btn.innerText = "PROCESSING...";
      log("Generating 3 variations...");

      const placeholders = [addImageToGallery(null, true), addImageToGallery(null, true), addImageToGallery(null, true)];

      try {
        const promises = [
          createImage(prompt).catch(e => ({error:e.message})), 
          createImage(prompt + ", v2").catch(e => ({error:e.message})), 
          createImage(prompt + ", v3").catch(e => ({error:e.message}))
        ];

        const results = await Promise.all(promises);

        results.forEach((res, index) => {
          if (typeof res === 'string') updateGalleryItem(placeholders[index], res);
          else updateGalleryItem(placeholders[index], null, true);
        });
        log("Batch complete.");
      } catch (e) {
        log("Batch Error: " + e.message);
        notify("Batch Failed", true);
      } finally {
        btn.disabled = false; btn.innerText = "CREATE ALL (3)";
      }
    }

    // --- 6. Gallery ---
    function addImageToGallery(url, isLoading = false) {
      const div = document.createElement('div');
      div.className = "gallery-item" + (isLoading ? " loading" : "");
      if (url) {
        const img = document.createElement('img');
        img.src = url;
        div.appendChild(img);
      }
      $('gallery').prepend(div);
      return div;
    }

    function updateGalleryItem(element, url, error = false) {
      element.classList.remove("loading");
      if (error) {
        element.innerText = "Failed";
        element.style.color = "red";
        return;
      }
      if (url) {
        const img = document.createElement('img');
        img.src = url;
        element.innerHTML = "";
        element.appendChild(img);
      }
    }

    // --- Init ---
    initParticles();
    checkEnvironment();

  </script>
</body>
</html>
